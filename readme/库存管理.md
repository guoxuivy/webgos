# 库存管理模块

## 1. 多仓库管理

### 仓库档案

- **多类型仓库**：支持总部总仓、门店仓、维修仓、翻新仓等多类型仓库
- **仓库信息**：记录仓库地址、负责人、存储容量、可存放商品类型（如维修仓仅存放待修商品）

## 2. 库存操作管理

### 入库管理

- **采购入库**：对接采购模块，采购商品到货后进行验收入库，生成入库单，记录"采购单编号、商品信息、入库仓库、验收结果、操作员"
- **回收入库**：对接回收模块，验机合格后自动生成入库单，记录 "回收单编号、商品序列号、入库仓库、操作员"
- **调拨入库**：其他仓库调拨商品到本仓，需扫码确认签收，更新库存
- **维修/翻新入库**：维修或翻新完成后，从维修仓/翻新仓转入可售仓，同步更新商品状态为 "已翻新"

### 出库管理

- **销售出库**：对接销售模块，订单确认后生成出库单，支持 "门店自提"（直接扣减门店仓）或 "总部发货"（扣减总仓）
- **调拨出库**：响应其他仓库调拨请求，生成出库单，记录物流信息
- **维修出库**：将可售仓商品转入维修仓，状态更新为 "维修中"
- **报废出库**：检测不合格或无法维修的商品，经审批后报废出库，记录报废原因（如 "主板损坏"）

### 批量操作

- **批量处理**：支持批量入库、批量出库（如门店集中调拨时），提高效率

## 3. 库存状态实时监控

- **库存明细视图**：按 "仓库 + 商品 + 状态" 展示库存数量（如 "总仓 - iPhone 13Pro-95 新 - 可售：15 台"）
- **序列号级跟踪**：每个商品的序列号绑定唯一库存记录，可查看其当前所在仓库、状态、入库时间、历史流转记录
- **库存锁定**：支持临时锁定库存（如客户预订时），锁定时效可配置（如 24 小时未支付自动解锁）

## 4. 智能调拨管理

### 调拨规则配置

- **自动调拨**：当门店某商品库存低于阈值（如≤3 台），系统自动向总仓或库存充足的门店发起调拨建议
- **手动调拨**：门店可主动发起调拨申请，总部审核后生成调拨单

### 调拨全流程跟踪

- **调拨单状态**：待审核 → 已审核 → 已出库 → 在途 → 已入库
- **物流关联**：支持录入物流单号，跟踪商品运输状态

## 5. 库存盘点与差异处理

### 定期盘点

- **盘点任务**：支持按仓库、按商品类别发起盘点任务，生成盘点清单
- **移动端盘点**：移动端扫码盘点，实时比对系统库存与实际库存
- **盘盈/盘亏记录**：自动生成差异单，需审批后调整库存，记录差异原因（如 "漏录入""损坏未记录"）

### 动态盘点

- **抽查盘点**：针对高频变动商品（如热销机型），支持不定期抽查盘点

## 6. 库存预警与分析

### 多维度预警

- **低库存预警**：某商品库存低于设定阈值时，推送提醒给门店和总部
- **滞销预警**：商品在库超过设定时长（如 60 天）未售出，提醒促销或调拨
- **临期保修预警**：二手商品保修到期前（如 30 天），提醒跟进客户是否需要延保

### 库存分析报表

- **库存周转率**：按商品类别、门店统计库存周转天数
- **库存结构分析**：各成色、各状态商品占比
- **区域库存分布**：哪些区域某类商品库存过剩/不足，支撑调拨决策

## 7. 库存日志与溯源

- **操作日志**：记录所有库存变动（入库/出库/调拨/盘点调整）的详细日志，包括操作人、时间、关联单据（如回收单/销售单/调拨单）
- **全生命周期追溯**：支持按商品序列号追溯全生命周期库存流转（如 "2023-10-01 回收入库总仓 → 2023-10-05 调拨至门店 A → 2023-10-08 销售出库"）

## 8. 模块联动性

- **商品管理与回收模块**：回收验机后自动创建商品档案，关联成色和初始状态
- **商品管理与销售模块**：销售时调用商品定价模型，生成最终售价
- **库存管理与门店管理**：实时同步各门店库存，支撑门店销售和调拨
- **库存管理与财务管理**：库存变动关联成本核算（如回收成本、维修成本），影响利润统计

## 9. 库存管理模块核心表（无库位管理）

### 9.1 仓库表（warehouse）

**用途**：管理所有仓库（总部仓、门店仓、维修仓等），无需库位信息

| 字段名 | 类型 | 长度 | 约束 | 说明 |
|--------|------|------|------|------|
| warehouse_id | INT | 11 | PRIMARY KEY, AUTO_INCREMENT | 仓库 ID |
| warehouse_name | VARCHAR | 100 | NOT NULL | 仓库名称（如 "总部总仓"、"北京朝阳门店仓"） |
| warehouse_type | VARCHAR | 20 | NOT NULL | 仓库类型（如 "HEADQUARTER"、"STORE"、"REPAIR"） |
| address | VARCHAR | 255 | NOT NULL | 仓库地址 |
| contact_person | VARCHAR | 50 | NULL | 联系人 |
| contact_phone | VARCHAR | 20 | NULL | 联系电话 |
| is_active | TINYINT | 1 | DEFAULT 1 | 是否启用 |
| create_time | DATETIME | - | DEFAULT CURRENT_TIMESTAMP | 创建时间 |

**索引**：idx_warehouse_type（warehouse_type）

### 9.2 库存记录表（inventory_record）

**用途**：记录商品实例的当前库存状态（仅关联仓库，不关联库位）

| 字段名 | 类型 | 长度 | 约束 | 说明 |
|--------|------|------|------|------|
| inventory_id | BIGINT | 20 | PRIMARY KEY, AUTO_INCREMENT | 库存记录 ID |
| instance_id | BIGINT | 20 | FOREIGN KEY (product_instance), UNIQUE | 商品实例 ID（一对一，每个实例唯一库存记录） |
| warehouse_id | INT | 11 | FOREIGN KEY (warehouse) | 当前所在仓库 ID |
| stock_quantity | INT | 11 | DEFAULT 1 | 库存数量（二手商品通常为 1） |
| lock_status | TINYINT | 1 | DEFAULT 0 | 锁定状态（0 = 未锁定，1 = 已锁定） |
| lock_expire_time | DATETIME | - | NULL | 锁定过期时间（如预订锁定 24 小时） |
| in_stock_time | DATETIME | - | NOT NULL | 入库时间 |
| update_time | DATETIME | - | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

**索引**：idx_warehouse_instance（warehouse_id, instance_id）、idx_lock_status（lock_status）

### 9.3 入库单表（stock_in_order）

**用途**：记录入库操作主单信息（简化库位相关字段）

| 字段名 | 类型 | 长度 | 约束 | 说明 |
|--------|------|------|------|------|
| in_order_id | BIGINT | 20 | PRIMARY KEY, AUTO_INCREMENT | 入库单 ID |
| order_no | VARCHAR | 50 | NOT NULL, UNIQUE | 入库单号（如 "IN20231001001"） |
| warehouse_id | INT | 11 | FOREIGN KEY (warehouse) | 入库仓库 ID |
| source_type | VARCHAR | 20 | NOT NULL | 入库来源（如 "PURCHASE"= 采购、"RECYCLE"= 回收、"TRANSFER"= 调拨、"REPAIR"= 维修完成） |
| source_id | BIGINT | 20 | NULL | 来源单据 ID（如采购单 ID、回收单 ID、调拨单 ID） |
| operator_id | INT | 11 | NOT NULL | 操作人 ID |
| operate_time | DATETIME | - | DEFAULT CURRENT_TIMESTAMP | 操作时间 |
| status | VARCHAR | 20 | NOT NULL | 状态（如 "PENDING"= 待确认、"COMPLETED"= 已完成） |
| remark | TEXT | - | NULL | 备注 |

**索引**：idx_order_no（order_no）、idx_warehouse_status（warehouse_id, status）

### 9.4 入库单明细表（stock_in_item）

**用途**：记录入库单中的商品明细（无库位信息）

| 字段名 | 类型 | 长度 | 约束 | 说明 |
|--------|------|------|------|------|
| item_id | BIGINT | 20 | PRIMARY KEY, AUTO_INCREMENT | 明细 ID |
| in_order_id | BIGINT | 20 | FOREIGN KEY (stock_in_order) | 关联入库单 ID |
| instance_id | BIGINT | 20 | FOREIGN KEY (product_instance) | 商品实例 ID |
| quantity | INT | 11 | DEFAULT 1 | 入库数量 |
| check_result | VARCHAR | 20 | NULL | 验收结果（如 "PASS"= 合格、"REJECT"= 不合格） |
| checker_id | INT | 11 | NULL | 验收人 ID |
| check_time | DATETIME | - | NULL | 验收时间 |

**索引**：idx_in_order（in_order_id）、idx_instance_in（instance_id）

### 9.5 出库单表（stock_out_order）

**用途**：记录出库操作主单信息（简化库位相关字段）

| 字段名 | 类型 | 长度 | 约束 | 说明 |
|--------|------|------|------|------|
| out_order_id | BIGINT | 20 | PRIMARY KEY, AUTO_INCREMENT | 出库单 ID |
| order_no | VARCHAR | 50 | NOT NULL, UNIQUE | 出库单号（如 "OUT20231001001"） |
| warehouse_id | INT | 11 | FOREIGN KEY (warehouse) | 出库仓库 ID |
| out_type | VARCHAR | 20 | NOT NULL | 出库类型（如 "SALE"= 销售、"TRANSFER"= 调拨、"REPAIR"= 送修、"SCRAP"= 报废） |
| related_id | BIGINT | 20 | NULL | 关联单据 ID（如销售单 ID、调拨单 ID） |
| operator_id | INT | 11 | NOT NULL | 操作人 ID |
| operate_time | DATETIME | - | DEFAULT CURRENT_TIMESTAMP | 操作时间 |
| status | VARCHAR | 20 | NOT NULL | 状态（如 "PENDING"= 待确认、"COMPLETED"= 已完成） |
| remark | TEXT | - | NULL | 备注 |

**索引**：idx_order_no（order_no）、idx_warehouse_type（warehouse_id, out_type）

### 9.6 出库单明细表（stock_out_item）

**用途**：记录出库单中的商品明细（无库位信息）

| 字段名 | 类型 | 长度 | 约束 | 说明 |
|--------|------|------|------|------|
| item_id | BIGINT | 20 | PRIMARY KEY, AUTO_INCREMENT | 明细 ID |
| out_order_id | BIGINT | 20 | FOREIGN KEY (stock_out_order) | 关联出库单 ID |
| instance_id | BIGINT | 20 | FOREIGN KEY (product_instance) | 商品实例 ID |
| quantity | INT | 11 | DEFAULT 1 | 出库数量 |
| reason | VARCHAR | 50 | NULL | 出库原因（如 "正常销售"、"质量问题报废"） |
| picker_id | INT | 11 | NULL | 拣货人 ID（无需库位定位，简化为记录操作人） |
| pick_time | DATETIME | - | NULL | 拣货时间 |

**索引**：idx_out_order（out_order_id）、idx_instance_out（instance_id）

### 9.7 调拨单表（transfer_order）

**用途**：记录仓库间调拨主单信息（保持不变，仅涉及仓库级调拨）

| 字段名 | 类型 | 长度 | 约束 | 说明 |
|--------|------|------|------|------|
| transfer_id | BIGINT | 20 | PRIMARY KEY, AUTO_INCREMENT | 调拨单 ID |
| transfer_no | VARCHAR | 50 | NOT NULL, UNIQUE | 调拨单号（如 "TF20231001001"） |
| from_warehouse_id | INT | 11 | FOREIGN KEY (warehouse) | 调出仓库 ID |
| to_warehouse_id | INT | 11 | FOREIGN KEY (warehouse) | 调入仓库 ID |
| apply_store_id | INT | 11 | NULL | 申请门店 ID（若由门店发起） |
| approver_id | INT | 11 | NULL | 审批人 ID |
| approve_time | DATETIME | - | NULL | 审批时间 |
| logistics_no | VARCHAR | 50 | NULL | 物流单号 |
| status | VARCHAR | 20 | NOT NULL | 状态（如 "PENDING_APPROVE"= 待审批、"IN_TRANSIT"= 在途、"COMPLETED"= 已完成） |
| create_time | DATETIME | - | DEFAULT CURRENT_TIMESTAMP | 创建时间 |

**索引**：idx_transfer_no（transfer_no）、idx_from_to_status（from_warehouse_id, to_warehouse_id, status）

### 9.8 调拨单明细表（transfer_item）

**用途**：记录调拨单中的商品明细（无库位信息）

| 字段名 | 类型 | 长度 | 约束 | 说明 |
|--------|------|------|------|------|
| item_id | BIGINT | 20 | PRIMARY KEY, AUTO_INCREMENT | 明细 ID |
| transfer_id | BIGINT | 20 | FOREIGN KEY (transfer_order) | 关联调拨单 ID |
| instance_id | BIGINT | 20 | FOREIGN KEY (product_instance) | 商品实例 ID |
| quantity | INT | 11 | DEFAULT 1 | 调拨数量 |
| receive_status | VARCHAR | 20 | DEFAULT "PENDING" | 接收状态（如 "PENDING"= 待接收、"RECEIVED"= 已接收） |
| receiver_id | INT | 11 | NULL | 接收人 ID |
| receive_time | DATETIME | - | NULL | 接收时间 |

**索引**：idx_transfer_id（transfer_id）

### 9.9 库存盘点单表（inventory_check_order）

**用途**：记录库存盘点主单信息（仅按仓库盘点，不细化库位）

| 字段名 | 类型 | 长度 | 约束 | 说明 |
|--------|------|------|------|------|
| check_order_id | BIGINT | 20 | PRIMARY KEY, AUTO_INCREMENT | 盘点单 ID |
| check_no | VARCHAR | 50 | NOT NULL, UNIQUE | 盘点单号（如 "CK20231001001"） |
| warehouse_id | INT | 11 | FOREIGN KEY (warehouse) | 盘点仓库 ID |
| check_type | VARCHAR | 20 | NOT NULL | 盘点类型（如 "REGULAR"= 定期、"SPOT"= 抽查） |
| checker_id | INT | 11 | NOT NULL | 盘点人 ID |
| start_time | DATETIME | - | NOT NULL | 开始时间 |
| end_time | DATETIME | - | NULL | 结束时间 |
| status | VARCHAR | 20 | NOT NULL | 状态（如 "IN_PROGRESS"= 进行中、"COMPLETED"= 已完成） |
| remark | TEXT | - | NULL | 备注 |

**索引**：idx_check_no（check_no）、idx_warehouse_status（warehouse_id, status）

### 9.10 库存差异单表（inventory_diff_order）

**用途**：记录盘点后的库存差异及调整结果（保持不变）

| 字段名 | 类型 | 长度 | 约束 | 说明 |
|--------|------|------|------|------|
| diff_order_id | BIGINT | 20 | PRIMARY KEY, AUTO_INCREMENT | 差异单 ID |
| diff_no | VARCHAR | 50 | NOT NULL, UNIQUE | 差异单号（如 "DF20231001001"） |
| check_order_id | BIGINT | 20 | FOREIGN KEY (inventory_check_order) | 关联盘点单 ID |
| warehouse_id | INT | 11 | FOREIGN KEY (warehouse) | 仓库 ID |
| handler_id | INT | 11 | NULL | 处理人 ID |
| handle_time | DATETIME | - | NULL | 处理时间 |
| status | VARCHAR | 20 | NOT NULL | 状态（如 "UNHANDLED"= 未处理、"ADJUSTED"= 已调整） |
| total_diff_value | DECIMAL | 12,2 | DEFAULT 0.00 | 差异总价值（元） |

**索引**：idx_diff_no（diff_no）、idx_check_order（check_order_id）

### 9.11 库存差异明细表（inventory_diff_item）

**用途**：记录具体商品的库存差异（保持不变）

| 字段名 | 类型 | 长度 | 约束 | 说明 |
|--------|------|------|------|------|
| diff_item_id | BIGINT | 20 | PRIMARY KEY, AUTO_INCREMENT | 差异明细 ID |
| diff_order_id | BIGINT | 20 | FOREIGN KEY (inventory_diff_order) | 关联差异单 ID |
| instance_id | BIGINT | 20 | FOREIGN KEY (product_instance) | 商品实例 ID |
| system_quantity | INT | 11 | NOT NULL | 系统库存数量 |
| actual_quantity | INT | 11 | NOT NULL | 实际盘点数量 |
| diff_quantity | INT | 11 | NOT NULL | 差异数量（actual - system） |
| diff_reason | VARCHAR | 100 | NULL | 差异原因（如 "漏录入"、"已售出未出库"） |
| adjust_status | VARCHAR | 20 | DEFAULT "UNADJUSTED" | 调整状态（如 "UNADJUSTED"= 未调整、"ADJUSTED"= 已调整） |

**索引**：idx_diff_order（diff_order_id）、idx_instance_diff（instance_id）

### 9.12 库存变动日志表（inventory_log）

**用途**：记录所有库存变动（简化库位相关字段）

| 字段名 | 类型 | 长度 | 约束 | 说明 |
|--------|------|------|------|------|
| log_id | BIGINT | 20 | PRIMARY KEY, AUTO_INCREMENT | 日志 ID |
| instance_id | BIGINT | 20 | FOREIGN KEY (product_instance) | 商品实例 ID |
| before_warehouse_id | INT | 11 | NULL | 变动前仓库 ID |
| after_warehouse_id | INT | 11 | NULL | 变动后仓库 ID |
| before_status_id | INT | 11 | NULL | 变动前商品状态 ID |
| after_status_id | INT | 11 | NULL | 变动后商品状态 ID |
| operation_type | VARCHAR | 20 | NOT NULL | 操作类型（如 "STOCK_IN"= 入库、"STOCK_OUT"= 出库、"TRANSFER"= 调拨） |
| related_order_no | VARCHAR | 50 | NULL | 关联单据号（如入库单号、销售单号） |
| operator_id | INT | 11 | NOT NULL | 操作人 ID |
| operate_time | DATETIME | - | DEFAULT CURRENT_TIMESTAMP | 操作时间 |
| remark | VARCHAR | 255 | NULL | 备注 |

**索引**：idx_instance_id（instance_id）、idx_operate_time（operate_time）、idx_related_order（related_order_no）

## 10. 采购管理

### 10.1 采购订单表（purchase_order）

**用途**：记录采购订单主单信息

| 字段名 | 类型 | 长度 | 约束 | 说明 |
|--------|------|------|------|------|
| purchase_id | BIGINT | 20 | PRIMARY KEY, AUTO_INCREMENT | 采购单 ID |
| purchase_no | VARCHAR | 50 | NOT NULL, UNIQUE | 采购单号（如 "PO20231001001"） |
| supplier_id | INT | 11 | NOT NULL | 供应商 ID |
| supplier_name | VARCHAR | 100 | NOT NULL | 供应商名称 |
| warehouse_id | INT | 11 | FOREIGN KEY (warehouse) | 采购仓库 ID |
| total_amount | DECIMAL | 12,2 | NOT NULL | 采购总金额 |
| status | VARCHAR | 20 | NOT NULL | 状态（如 "PENDING"= 待确认、"APPROVED"= 已审核、"PART_IN"= 部分入库、"COMPLETED"= 已完成） |
| operator_id | INT | 11 | NOT NULL | 操作人 ID |
| approve_id | INT | 11 | NULL | 审核人 ID |
| approve_time | DATETIME | - | NULL | 审核时间 |
| create_time | DATETIME | - | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| update_time | DATETIME | - | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

**索引**：idx_purchase_no（purchase_no）、idx_supplier（supplier_id）、idx_warehouse_status（warehouse_id, status）

### 10.2 采购订单明细表（purchase_item）

**用途**：记录采购订单中的商品明细

| 字段名 | 类型 | 长度 | 约束 | 说明 |
|--------|------|------|------|------|
| item_id | BIGINT | 20 | PRIMARY KEY, AUTO_INCREMENT | 明细 ID |
| purchase_id | BIGINT | 20 | FOREIGN KEY (purchase_order) | 关联采购单 ID |
| model_id | INT | 11 | NOT NULL | 商品型号 ID |
| quantity | INT | 11 | NOT NULL | 采购数量 |
| price | DECIMAL | 12,2 | NOT NULL | 采购单价 |
| amount | DECIMAL | 12,2 | NOT NULL | 金额（quantity * price） |
| received_quantity | INT | 11 | DEFAULT 0 | 已入库数量 |
| create_time | DATETIME | - | DEFAULT CURRENT_TIMESTAMP | 创建时间 |

**索引**：idx_purchase_id（purchase_id）、idx_model_id（model_id）

### 10.3 供应商表（supplier）

**用途**：记录供应商信息

| 字段名 | 类型 | 长度 | 约束 | 说明 |
|--------|------|------|------|------|
| supplier_id | INT | 11 | PRIMARY KEY, AUTO_INCREMENT | 供应商 ID |
| supplier_code | VARCHAR | 50 | NOT NULL, UNIQUE | 供应商编码 |
| supplier_name | VARCHAR | 100 | NOT NULL | 供应商名称 |
| contact_person | VARCHAR | 50 | NULL | 联系人 |
| phone | VARCHAR | 20 | NULL | 联系电话 |
| email | VARCHAR | 100 | NULL | 邮箱 |
| address | VARCHAR | 255 | NULL | 地址 |
| status | TINYINT | 1 | DEFAULT 1 | 状态（1=启用，0=禁用） |
| create_time | DATETIME | - | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| update_time | DATETIME | - | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

**索引**：idx_supplier_code（supplier_code）、idx_supplier_name（supplier_name）
