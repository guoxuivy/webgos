# RBAC权限管理

## 1. 概述

RBAC（Role-Based Access Control，基于角色的访问控制）是系统安全的重要组成部分。本系统采用RBAC模型实现权限管理，通过用户、角色和权限的多对多关系，实现灵活的权限控制。

### 1.1 核心概念

- **用户（User）**：系统的使用者，可以被分配一个或多个角色
- **角色（RBACRole）**：一组权限的集合，可以分配给一个或多个用户
- **权限（RBACPermission）**：系统中最小的不可再分的访问控制单元，如"查看商品"、"创建订单"等

### 1.2 RBAC模型特点

- 灵活性：用户可以通过角色继承权限，无需直接分配权限
- 可扩展性：可以方便地添加新的角色和权限
- 易管理：通过角色管理权限，简化权限分配过程

## 2. 数据模型设计

### 2.1 用户模型（User）

用户模型在user.go中定义，与RBAC相关的部分如下：

```go
type User struct {
    gorm.Model
    Username string     `gorm:"size:50;unique" json:"username"`
    Password string     `gorm:"size:100" json:"-"`
    Nickname string     `gorm:"size:50" json:"nickname"`
    Roles    []RBACRole `gorm:"many2many:user_roles;" json:"roles"`
}
```

### 2.2 角色模型（RBACRole）

```go
type RBACRole struct {
    gorm.Model
    Name        string           `gorm:"size:50;unique" json:"name"`
    Description string           `gorm:"size:200" json:"description"`
    Permissions []RBACPermission `gorm:"many2many:role_permissions;" json:"permissions"`
    Users       []User           `gorm:"many2many:user_roles;" json:"-"`
}
```

### 2.3 权限模型（RBACPermission）

```go
type RBACPermission struct {
    gorm.Model
    Name        string     `gorm:"size:100;unique" json:"name"` // 权限名称，如：/api/products:get
    Description string     `gorm:"size:200" json:"description"` // 权限描述
    Path        string     `gorm:"size:255" json:"path"`        // 路由路径
    Method      string     `gorm:"size:20" json:"method"`       // 请求方法
    Roles       []RBACRole `gorm:"many2many:role_permissions;" json:"-"`
}
```

### 2.4 关联表

系统使用GORM的many2many特性自动管理关联表，无需手动定义关联表结构。

## 3. 权限自动生成机制

系统实现了基于路由的权限点自动生成机制，无需手动维护权限点。

### 3.1 权限标识规则

权限标识采用 `路径:HTTP方法` 的格式，例如：
- `/api/products:GET` - 查看商品列表
- `/api/products:add:POST` - 创建商品
- `/api/inventory/in:POST` - 商品入库

### 3.2 自动生成流程

1. 在路由注册时，通过封装的[RouterWrapper](file://d:\Goroot\webgos\internal\routes\router_wrapper.go#L15-L15)收集路由信息
2. 系统启动时，将收集到的路由信息同步到数据库作为权限点
3. 如果权限点已存在，则更新其描述信息；如果不存在，则创建新权限点

### 3.3 路径处理规范

- 所有路径统一转换为小写
- 去除重复的斜杠
- 保持路径结构清晰

## 4. 权限验证流程

### 4.1 JWT认证

系统使用JWT（JSON Web Token）进行用户身份认证：

1. 用户登录成功后，系统生成JWT令牌并返回给客户端
2. 客户端在后续请求中通过Authorization头携带令牌
3. 服务端验证令牌有效性并解析用户信息

### 4.2 权限检查

权限检查通过中间件实现：

1. 获取当前请求的路径和HTTP方法
2. 根据路径和方法构造权限标识
3. 查询当前用户是否拥有该权限
4. 如果有权限，则继续处理请求；否则返回403错误

## 5. API接口

### 5.1 角色管理

#### 创建角色

```bash
POST /api/rbac/add/role
{
  "name": "管理员",
  "description": "系统管理员角色"
}
```

#### 获取角色详情

```bash
GET /api/rbac/role/{id}
```

#### 获取用户角色

```bash
GET /api/rbac/user/{user_id}/roles
```

### 5.2 权限分配

#### 分配角色给用户

```bash
POST /api/rbac/assign/roles
{
  "user_id": 1,
  "role_ids": [1, 2]
}
```

#### 分配权限给角色

```bash
POST /api/rbac/assign/permissions
{
  "role_id": 1,
  "permission_ids": [1, 2, 3]
}
```

## 6. 最佳实践

### 6.1 角色设计原则

- 遵循最小权限原则，只为角色分配完成工作所需的最少权限
- 角色命名应具有明确的业务含义
- 避免为每个用户创建单独的角色

### 6.2 权限管理

- 利用系统自动同步机制，确保权限点与路由保持一致
- 通过描述性文字清楚表达每个权限点的作用
- 定期审查角色权限分配，确保符合安全要求